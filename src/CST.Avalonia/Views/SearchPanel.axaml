<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:CST.Avalonia.ViewModels"
             xmlns:models="using:CST.Avalonia.Models"
             x:Class="CST.Avalonia.Views.SearchPanel"
             x:DataType="vm:SearchViewModel"
             Name="SearchPanelControl">
  
  <UserControl.Styles>
    <Style Selector="TextBlock.section-header">
      <Setter Property="FontWeight" Value="SemiBold"/>
      <Setter Property="Margin" Value="0,8,0,4"/>
      <Setter Property="FontSize" Value="12"/>
    </Style>
    
    <Style Selector="TextBlock.count-badge">
      <Setter Property="FontSize" Value="11"/>
      <Setter Property="Foreground" Value="{DynamicResource SystemAccentColor}"/>
      <Setter Property="FontWeight" Value="Medium"/>
    </Style>
    
    <Style Selector="Border.search-section">
      <Setter Property="Background" Value="{DynamicResource CardBackgroundFillColorDefaultBrush}"/>
      <Setter Property="CornerRadius" Value="6"/>
      <Setter Property="Padding" Value="12"/>
      <Setter Property="Margin" Value="8"/>
    </Style>
    
    <Style Selector="ToggleSwitch.filter-switch">
      <Setter Property="Margin" Value="4,2"/>
    </Style>
  </UserControl.Styles>

  <Grid RowDefinitions="Auto,*,Auto">
    
    <!-- Search Input Area -->
    <Border Grid.Row="0" Classes="search-section">
      <StackPanel>
        <!-- Search Field -->
        <TextBlock Classes="section-header" Text="Search Terms"/>
        <TextBox Name="SearchInput" 
                 Text="{Binding SearchText}"
                 Watermark="Enter search terms..."
                 Margin="0,4,0,8">
          <TextBox.KeyBindings>
            <KeyBinding Gesture="Enter" Command="{Binding SearchCommand}"/>
            <KeyBinding Gesture="Escape" Command="{Binding ClearCommand}"/>
          </TextBox.KeyBindings>
        </TextBox>
        
        <!-- Search Mode Selector -->
        <TextBlock Classes="section-header" Text="Search Mode"/>
        <ComboBox Name="SearchModeCombo" 
                  SelectedItem="{Binding SelectedSearchMode}"
                  Margin="0,4,0,8">
          <ComboBoxItem Content="Exact Match">
            <ComboBoxItem.Tag>
              <models:SearchMode>Exact</models:SearchMode>
            </ComboBoxItem.Tag>
          </ComboBoxItem>
          <ComboBoxItem Content="Wildcard (*?)">
            <ComboBoxItem.Tag>
              <models:SearchMode>Wildcard</models:SearchMode>
            </ComboBoxItem.Tag>
          </ComboBoxItem>
          <ComboBoxItem Content="Regex">
            <ComboBoxItem.Tag>
              <models:SearchMode>Regex</models:SearchMode>
            </ComboBoxItem.Tag>
          </ComboBoxItem>
        </ComboBox>
        
        <!-- Collection Filter (Placeholder) -->
        <TextBlock Classes="section-header" Text="Book Collection"/>
        <ComboBox Name="CollectionFilter" 
                  SelectedIndex="0"
                  Margin="0,4,0,8">
          <ComboBoxItem Content="All Books"/>
          <ComboBoxItem Content="Custom Collections..." IsEnabled="False"/>
        </ComboBox>
        
        <!-- Book Type Filters -->
        <Expander Header="Filter by Collection" IsExpanded="False" Margin="0,4,0,0">
          <StackPanel Margin="8,8,0,0">
            <!-- Pitaka Filters -->
            <TextBlock Text="Pitaka:" FontWeight="Medium" FontSize="11" Margin="0,0,0,4"/>
            <WrapPanel Margin="0,0,0,8">
              <ToggleSwitch Classes="filter-switch" Content="Vinaya" 
                           IsChecked="{Binding IncludeVinaya}" FontSize="11"/>
              <ToggleSwitch Classes="filter-switch" Content="Sutta" 
                           IsChecked="{Binding IncludeSutta}" FontSize="11"/>
              <ToggleSwitch Classes="filter-switch" Content="Abhidhamma" 
                           IsChecked="{Binding IncludeAbhidhamma}" FontSize="11"/>
            </WrapPanel>
            
            <!-- Commentary Level Filters -->
            <TextBlock Text="Commentary Level:" FontWeight="Medium" FontSize="11" Margin="0,4,0,4"/>
            <WrapPanel Margin="0,0,0,8">
              <ToggleSwitch Classes="filter-switch" Content="Mūla" 
                           IsChecked="{Binding IncludeMula}" FontSize="11"/>
              <ToggleSwitch Classes="filter-switch" Content="Aṭṭhakathā" 
                           IsChecked="{Binding IncludeAttha}" FontSize="11"/>
              <ToggleSwitch Classes="filter-switch" Content="Ṭīkā" 
                           IsChecked="{Binding IncludeTika}" FontSize="11"/>
            </WrapPanel>
            
            <!-- Other Texts -->
            <ToggleSwitch Classes="filter-switch" Content="Other Texts" 
                         IsChecked="{Binding IncludeOther}" FontSize="11"/>
          </StackPanel>
        </Expander>
      </StackPanel>
    </Border>
    
    <!-- Search Results -->
    <Grid Grid.Row="1" ColumnDefinitions="*,4,*" Margin="8,0">
      
      <!-- Terms List -->
      <Border Grid.Column="0" 
              Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
              CornerRadius="6" Padding="8">
        <Grid RowDefinitions="Auto,*">
          <TextBlock Grid.Row="0" Classes="section-header" Text="Matching Terms"/>
          
          <ListBox Grid.Row="1" Name="TermsList"
                   ItemsSource="{Binding Terms}"
                   SelectionMode="Multiple"
                   SelectedItems="{Binding SelectedTerms}"
                   Background="Transparent"
                   BorderThickness="0">
            <ListBox.ItemTemplate>
              <DataTemplate x:DataType="vm:MatchingTermViewModel">
                <Grid ColumnDefinitions="*,Auto" MinHeight="32">
                  <TextBlock Grid.Column="0" 
                            Text="{Binding DisplayTerm}" 
                            VerticalAlignment="Center"
                            TextWrapping="NoWrap"
                            TextTrimming="CharacterEllipsis"/>
                  <Border Grid.Column="1" 
                         Background="{DynamicResource SystemAccentColorLight2}"
                         CornerRadius="10"
                         Padding="6,2"
                         Margin="8,0,0,0">
                    <TextBlock Text="{Binding TotalCount}"
                              FontSize="10"
                              FontWeight="Medium"
                              Foreground="{DynamicResource SystemAccentColorDark1}"/>
                  </Border>
                </Grid>
              </DataTemplate>
            </ListBox.ItemTemplate>
          </ListBox>
        </Grid>
      </Border>
      
      <GridSplitter Grid.Column="1" 
                    Background="{DynamicResource CardStrokeColorDefaultBrush}"
                    Width="1"
                    HorizontalAlignment="Center"/>
      
      <!-- Book Occurrences -->
      <Border Grid.Column="2" 
              Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
              CornerRadius="6" Padding="8">
        <Grid RowDefinitions="Auto,*">
          <TextBlock Grid.Row="0" Classes="section-header" Text="Books"/>
          
          <ListBox Grid.Row="1" Name="OccurrencesList"
                   ItemsSource="{Binding Occurrences}"
                   Background="Transparent"
                   BorderThickness="0">
            <ListBox.ItemTemplate>
              <DataTemplate x:DataType="vm:BookOccurrenceViewModel">
                <Grid ColumnDefinitions="*,Auto" MinHeight="32">
                  <TextBlock Grid.Column="0" 
                            Text="{Binding DisplayName}" 
                            VerticalAlignment="Center"
                            TextWrapping="NoWrap"
                            TextTrimming="CharacterEllipsis"
                            FontSize="11"/>
                  <Border Grid.Column="1" 
                         Background="{DynamicResource SystemAccentColorLight2}"
                         CornerRadius="10"
                         Padding="6,2"
                         Margin="8,0,0,0">
                    <TextBlock Text="{Binding Count}"
                              FontSize="10"
                              FontWeight="Medium"
                              Foreground="{DynamicResource SystemAccentColorDark1}"/>
                  </Border>
                </Grid>
              </DataTemplate>
            </ListBox.ItemTemplate>
            
            <!-- Double-click to open book -->
            <ListBox.Styles>
              <Style Selector="ListBoxItem">
                <Setter Property="Padding" Value="4"/>
              </Style>
            </ListBox.Styles>
          </ListBox>
        </Grid>
      </Border>
    </Grid>
    
    <!-- Status Bar -->
    <Border Grid.Row="2" 
            Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}"
            Padding="12,8"
            Margin="8">
      <Grid ColumnDefinitions="*,*,Auto">
        <!-- Statistics -->
        <TextBlock Grid.Column="0" 
                   Text="{Binding TermStats}"
                   FontSize="11"
                   VerticalAlignment="Center"/>
        <TextBlock Grid.Column="1" 
                   Text="{Binding OccurrenceStats}"
                   FontSize="11"
                   VerticalAlignment="Center"/>
        
        <!-- Search Status -->
        <StackPanel Grid.Column="2" Orientation="Horizontal">
          <!-- Loading indicator -->
          <Border IsVisible="{Binding IsSearching}"
                  Background="{DynamicResource SystemAccentColor}"
                  Width="12" Height="12"
                  CornerRadius="6"
                  Margin="0,0,8,0">
            <Border.RenderTransform>
              <RotateTransform/>
            </Border.RenderTransform>
            <Border.Styles>
              <Style Selector="Border">
                <Style.Animations>
                  <Animation Duration="0:0:1" IterationCount="Infinite">
                    <KeyFrame Cue="0%">
                      <Setter Property="RenderTransform">
                        <RotateTransform Angle="0"/>
                      </Setter>
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                      <Setter Property="RenderTransform">
                        <RotateTransform Angle="360"/>
                      </Setter>
                    </KeyFrame>
                  </Animation>
                </Style.Animations>
              </Style>
            </Border.Styles>
          </Border>
          
          <TextBlock Text="{Binding StatusText}"
                     FontSize="11"
                     VerticalAlignment="Center"
                     Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
        </StackPanel>
      </Grid>
    </Border>
    
  </Grid>
</UserControl>