<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:CST.Avalonia.ViewModels"
             xmlns:models="using:CST.Avalonia.Models"
             xmlns:converters="using:CST.Avalonia.Converters"
             x:Class="CST.Avalonia.Views.SearchPanel"
             x:DataType="vm:SearchViewModel"
             Name="SearchPanelControl">
  
  <UserControl.Styles>
    <Style Selector="TextBlock.section-header">
      <Setter Property="FontWeight" Value="SemiBold"/>
      <Setter Property="Margin" Value="0,8,0,4"/>
      <Setter Property="FontSize" Value="12"/>
    </Style>
    
    <Style Selector="Border.search-input-container">
      <Setter Property="Background" Value="{DynamicResource TextControlBackgroundBrush}"/>
      <Setter Property="CornerRadius" Value="4"/>
    </Style>
    
    <Style Selector="Button.clear-button:pointerover">
      <Setter Property="Background" Value="{DynamicResource SubtleFillColorSecondaryBrush}"/>
    </Style>
    
    <Style Selector="TextBlock.count-badge">
      <Setter Property="FontSize" Value="11"/>
      <Setter Property="Foreground" Value="{DynamicResource SystemAccentColor}"/>
      <Setter Property="FontWeight" Value="Medium"/>
    </Style>
    
    <Style Selector="Border.search-section">
      <Setter Property="Background" Value="{DynamicResource CardBackgroundFillColorDefaultBrush}"/>
      <Setter Property="CornerRadius" Value="6"/>
      <Setter Property="Padding" Value="12"/>
      <Setter Property="Margin" Value="8"/>
    </Style>
    
    <Style Selector="CheckBox.filter-checkbox">
      <Setter Property="Margin" Value="8,2"/>
      <Setter Property="FontSize" Value="12"/>
    </Style>
    
    <!-- Alternating row colors for better readability -->
    <Style Selector="ListBoxItem:nth-child(2n)">
      <Setter Property="Background" Value="{DynamicResource SubtleFillColorTransparentBrush}"/>
    </Style>

    <!-- Hover effect for list items -->
    <Style Selector="ListBoxItem:pointerover">
      <Setter Property="Background" Value="{DynamicResource SubtleFillColorSecondaryBrush}"/>
    </Style>
    
    <!-- Selected item styling -->
    <Style Selector="ListBoxItem:selected">
      <Setter Property="Background" Value="{DynamicResource SystemAccentColorLight3}"/>
      <Setter Property="Foreground" Value="{DynamicResource TextOnAccentFillColorPrimaryBrush}"/>
    </Style>
  </UserControl.Styles>

  <Grid RowDefinitions="Auto,*,Auto">
    
    <!-- Search Input Area -->
    <Border Grid.Row="0" Classes="search-section">
      <StackPanel>
        <!-- Search Field -->
        <TextBlock Classes="section-header" Text="Search Terms"/>
        <Border Margin="0,4,0,8" Classes="search-input-container">
          <Grid ColumnDefinitions="Auto,*,Auto">
            <!-- Search Icon -->
            <PathIcon Grid.Column="0" 
                    Data="M11.5,2.75 C16.3324916,2.75 20.25,6.66750844 20.25,11.5 C20.25,13.6461673 19.5328634,15.6290602 18.3348847,17.2094862 L23.0303301,21.9052023 C23.3232233,22.1980955 23.3232233,22.6730712 23.0303301,22.9659645 L22.9696699,23.0266246 C22.6767767,23.3195179 22.2018011,23.3195179 21.9089078,23.0266246 L17.2094862,18.3348847 C15.6290602,19.5328634 13.6461673,20.25 11.5,20.25 C6.66750844,20.25 2.75,16.3324916 2.75,11.5 C2.75,6.66750844 6.66750844,2.75 11.5,2.75 Z M11.5,4.25 C7.49593645,4.25 4.25,7.49593645 4.25,11.5 C4.25,15.5040635 7.49593645,18.75 11.5,18.75 C15.5040635,18.75 18.75,15.5040635 18.75,11.5 C18.75,7.49593645 15.5040635,4.25 11.5,4.25 Z"
                    Height="14" 
                    Width="14"
                    Margin="8,0,4,0"
                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                    VerticalAlignment="Center"/>
          
          <!-- Search Input -->
          <TextBox Grid.Column="1" 
                   Name="SearchInput" 
                   Text="{Binding SearchText}"
                   Watermark="Enter search terms..."
                   BorderThickness="0"
                   Background="Transparent">
            <TextBox.KeyBindings>
              <KeyBinding Gesture="Enter" Command="{Binding SearchCommand}"/>
              <KeyBinding Gesture="Escape" Command="{Binding ClearCommand}"/>
            </TextBox.KeyBindings>
          </TextBox>
          
            <!-- Clear Button / Progress Indicator -->
            <Panel Grid.Column="2" Margin="4,0,8,0">
              <!-- Progress Indicator -->
              <ProgressBar IsIndeterminate="{Binding IsSearching}"
                          IsVisible="{Binding IsSearching}"
                          Height="16" 
                          Width="16"
                          MinHeight="16"
                          MinWidth="16"
                          VerticalAlignment="Center"/>
              
              <!-- Clear Button -->
              <Button Command="{Binding ClearCommand}"
                      IsVisible="{Binding !IsSearching}"
                      Classes="clear-button"
                      Background="Transparent"
                      BorderThickness="0"
                      Padding="4"
                      CornerRadius="3"
                      VerticalAlignment="Center">
                <Button.IsVisible>
                  <MultiBinding Converter="{x:Static BoolConverters.And}">
                    <Binding Path="!IsSearching"/>
                    <Binding Path="SearchText" Converter="{x:Static StringConverters.IsNotNullOrEmpty}"/>
                  </MultiBinding>
                </Button.IsVisible>
                <PathIcon Data="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                         Height="12" 
                         Width="12"
                         Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
              </Button>
            </Panel>
          </Grid>
        </Border>
        
        <!-- Search Mode Selector -->
        <TextBlock Classes="section-header" Text="Search Mode"/>
        <ComboBox Name="SearchModeCombo" 
                  ItemsSource="{Binding SearchModes}"
                  SelectedItem="{Binding SelectedSearchMode}"
                  Margin="0,4,0,8">
          <ComboBox.ItemTemplate>
            <DataTemplate>
              <TextBlock Text="{Binding DisplayName}"/>
            </DataTemplate>
          </ComboBox.ItemTemplate>
        </ComboBox>

        <!-- Word Distance Slider (Proximity Search) -->
        <StackPanel Orientation="Vertical" Margin="0,8,0,8"
                    IsVisible="{Binding IsProximitySearchEnabled}">
          <Grid ColumnDefinitions="Auto,*,Auto">
            <TextBlock Grid.Column="0"
                      Text="Word Distance:"
                      VerticalAlignment="Center"
                      FontWeight="Medium"
                      FontSize="12"
                      Margin="0,0,10,0"/>
            <Slider Grid.Column="1"
                   Name="ProximitySlider"
                   Minimum="1"
                   Maximum="50"
                   Value="{Binding ProximityDistance}"
                   TickFrequency="5"
                   TickPlacement="BottomRight"
                   VerticalAlignment="Center"/>
            <TextBlock Grid.Column="2"
                      Text="{Binding ProximityDistance}"
                      VerticalAlignment="Center"
                      FontWeight="Medium"
                      FontSize="12"
                      Margin="10,0,0,0"
                      MinWidth="30"
                      HorizontalAlignment="Right"/>
          </Grid>
          <TextBlock Text="Words can appear within this many positions of each other"
                    FontSize="10"
                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                    Margin="0,4,0,0"/>
        </StackPanel>

        <!-- Phrase Search Indicator -->
        <Border IsVisible="{Binding IsPhraseSearch}"
                Background="{DynamicResource SystemAccentColorLight3}"
                CornerRadius="4"
                Padding="8,6"
                Margin="0,8,0,8">
          <StackPanel Orientation="Horizontal">
            <PathIcon Data="M12 2C11.5 2 11 2.19 10.59 2.59L2.59 10.59C1.8 11.37 1.8 12.63 2.59 13.41L10.59 21.41C11.37 22.2 12.63 22.2 13.41 21.41L21.41 13.41C22.2 12.63 22.2 11.37 21.41 10.59L13.41 2.59C13 2.19 12.5 2 12 2M12 4L20 12L12 20L4 12Z"
                     Height="14"
                     Width="14"
                     Margin="0,0,6,0"
                     Foreground="{DynamicResource SystemAccentColorDark1}"
                     VerticalAlignment="Center"/>
            <TextBlock Text="Phrase search: exact word order"
                      FontSize="11"
                      FontStyle="Italic"
                      Foreground="{DynamicResource SystemAccentColorDark1}"
                      VerticalAlignment="Center"/>
          </StackPanel>
        </Border>

        <!-- Book Type Filters -->
        <Expander Name="FilterExpander" IsExpanded="False" Margin="0,4,0,0">
          <Expander.Header>
            <Grid ColumnDefinitions="Auto,*,Auto">
              <TextBlock Grid.Column="0" Text="Include Text Types" FontWeight="Medium"/>
              <TextBlock Grid.Column="1" Text="{Binding FilterSummary}" 
                        FontSize="11" 
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Margin="8,0,0,0"
                        IsVisible="{Binding !#FilterExpander.IsExpanded}"/>
              <TextBlock Grid.Column="2" Text="{Binding BookCountLabel}" 
                        FontSize="11" 
                        Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                        Margin="8,0,0,0"/>
            </Grid>
          </Expander.Header>
          <StackPanel Margin="8,8,0,0">
            <!-- Quick select buttons -->
            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
              <Button Command="{Binding SelectAllFiltersCommand}" 
                      Content="Select All" 
                      FontSize="11"
                      Padding="8,4"
                      Margin="0,0,4,0"/>
              <Button Command="{Binding SelectNoneFiltersCommand}" 
                      Content="Select None" 
                      FontSize="11"
                      Padding="8,4"/>
            </StackPanel>
            <!-- Pitaka Filters -->
            <TextBlock Text="Pitaka:" FontWeight="Medium" FontSize="11" Margin="0,0,0,4"/>
            <WrapPanel Margin="0,0,0,8">
              <CheckBox Classes="filter-checkbox" Content="Vinaya" 
                       IsChecked="{Binding IncludeVinaya}"/>
              <CheckBox Classes="filter-checkbox" Content="Sutta" 
                       IsChecked="{Binding IncludeSutta}"/>
              <CheckBox Classes="filter-checkbox" Content="Abhidhamma" 
                       IsChecked="{Binding IncludeAbhidhamma}"/>
            </WrapPanel>
            
            <!-- Commentary Level Filters -->
            <TextBlock Text="Commentary Level:" FontWeight="Medium" FontSize="11" Margin="0,4,0,4"/>
            <WrapPanel Margin="0,0,0,8">
              <CheckBox Classes="filter-checkbox" Content="Mūla" 
                       IsChecked="{Binding IncludeMula}"/>
              <CheckBox Classes="filter-checkbox" Content="Aṭṭhakathā" 
                       IsChecked="{Binding IncludeAttha}"/>
              <CheckBox Classes="filter-checkbox" Content="Ṭīkā" 
                       IsChecked="{Binding IncludeTika}"/>
            </WrapPanel>
            
            <!-- Other Texts -->
            <CheckBox Classes="filter-checkbox" Content="Other Texts" 
                     IsChecked="{Binding IncludeOther}"/>
          </StackPanel>
        </Expander>
      </StackPanel>
    </Border>
    
    <!-- Search Results -->
    <Grid Grid.Row="1" ColumnDefinitions="*,4,*" Margin="8,0">
      
      <!-- Terms List -->
      <Border Grid.Column="0" 
              Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
              CornerRadius="6" Padding="8">
        <Grid RowDefinitions="Auto,*">
          <TextBlock Grid.Row="0" Classes="section-header" Text="Matching Terms"/>
          
          <ListBox Grid.Row="1" Name="TermsList"
                   ItemsSource="{Binding Terms}"
                   SelectionMode="Multiple"
                   Background="Transparent"
                   BorderThickness="0">
            <ListBox.ItemTemplate>
              <DataTemplate x:DataType="vm:MatchingTermViewModel">
                <Grid ColumnDefinitions="*,Auto" MinHeight="24" Margin="0,0,14,0">
                  <TextBlock Grid.Column="0" 
                            Text="{Binding DisplayTerm}" 
                            VerticalAlignment="Center"
                            TextWrapping="NoWrap"
                            TextTrimming="CharacterEllipsis"
                            converters:FontHelper.DynamicFontFamily="{Binding $parent[UserControl].DataContext.CurrentScriptFontFamily}"
                            converters:FontHelper.DynamicFontSize="{Binding $parent[UserControl].DataContext.CurrentScriptFontSize}"/>
                  <Border Grid.Column="1" 
                         Background="{DynamicResource SystemAccentColorLight2}"
                         CornerRadius="10"
                         Padding="6,2"
                         Margin="4,0,0,0"
                         MinWidth="20"
                         MinHeight="18">
                    <TextBlock Text="{Binding TotalCount}"
                              FontSize="10"
                              FontWeight="Medium"
                              Foreground="{DynamicResource SystemAccentColorDark1}"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Center"/>
                  </Border>
                </Grid>
              </DataTemplate>
            </ListBox.ItemTemplate>
            
            <!-- Compact item styling to match Books list -->
            <ListBox.Styles>
              <Style Selector="ListBoxItem">
                <Setter Property="Padding" Value="4"/>
                <Setter Property="MinHeight" Value="0"/>
              </Style>
            </ListBox.Styles>
          </ListBox>
        </Grid>
      </Border>
      
      <GridSplitter Grid.Column="1" 
                    Background="{DynamicResource CardStrokeColorDefaultBrush}"
                    Width="1"
                    HorizontalAlignment="Center"/>
      
      <!-- Book Occurrences -->
      <Border Grid.Column="2" 
              Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
              CornerRadius="6" Padding="8">
        <Grid RowDefinitions="Auto,*">
          <TextBlock Grid.Row="0" Classes="section-header" Text="Books"/>
          
          <ListBox Grid.Row="1" Name="OccurrencesList"
                   ItemsSource="{Binding Occurrences}"
                   Background="Transparent"
                   BorderThickness="0"
                   FontFamily="{Binding CurrentScriptFontFamily}"
                   FontSize="{Binding CurrentScriptFontSize}">
            <ListBox.ItemTemplate>
              <DataTemplate x:DataType="vm:BookOccurrenceViewModel">
                <Grid ColumnDefinitions="*,Auto" MinHeight="24" Margin="0,0,14,0">
                  <TextBlock Grid.Column="0" 
                            Text="{Binding DisplayName}" 
                            VerticalAlignment="Center"
                            TextWrapping="NoWrap"
                            TextTrimming="CharacterEllipsis"
                            converters:FontHelper.DynamicFontFamily="{Binding $parent[UserControl].DataContext.CurrentScriptFontFamily}"
                            converters:FontHelper.DynamicFontSize="{Binding $parent[UserControl].DataContext.CurrentScriptFontSize}"/>
                  <Border Grid.Column="1" 
                         Background="{DynamicResource SystemAccentColorLight2}"
                         CornerRadius="10"
                         Padding="6,2"
                         Margin="4,0,0,0"
                         MinWidth="20"
                         MinHeight="18">
                    <TextBlock Text="{Binding Count}"
                              FontSize="10"
                              FontWeight="Medium"
                              Foreground="{DynamicResource SystemAccentColorDark1}"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Center"/>
                  </Border>
                </Grid>
              </DataTemplate>
            </ListBox.ItemTemplate>
            
            <!-- Double-click to open book -->
            <ListBox.Styles>
              <Style Selector="ListBoxItem">
                <Setter Property="Padding" Value="4"/>
                <Setter Property="MinHeight" Value="0"/>
              </Style>
            </ListBox.Styles>
          </ListBox>
        </Grid>
      </Border>
    </Grid>
    
    <!-- Status Bar -->
    <Border Grid.Row="2" 
            Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}"
            Padding="12,8"
            Margin="8">
      <Grid ColumnDefinitions="*,*">
        <!-- Statistics aligned with Terms and Books columns -->
        <TextBlock Grid.Column="0" 
                   Text="{Binding TermStats}"
                   FontSize="11"
                   VerticalAlignment="Center"/>
        <TextBlock Grid.Column="1" 
                   Text="{Binding OccurrenceStats}"
                   FontSize="11"
                   VerticalAlignment="Center"/>
      </Grid>
    </Border>
    
  </Grid>
</UserControl>